<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Paws Connect</title>
    <link href="StyleCSS.css" rel="stylesheet">
    
</head>
<body>

<header>
    <div class="logo">
        <img src="img/PawLogo.png" alt="Paws Connect Logo" class="logo-image">
        <span class="logo-text">Paws Connect</span>
    </div>
    <nav>
        <ul class="nav">
            <li><a href="home_main.php" class="home-btn">Home</a></li>
            <li><a href="adoptable-cats.php">Adopt Cats</a></li>
            <li><a href="lost-cats.php">Lost Cats</a></li>
            <li><a href="sick.php">Sick Cats</a></li>
            <li class="dropdown">
                <a href="#">Account <span class="arrow">‚ñ≤</span></a>
                <ul class="dropdown-content">
                    <li><a href="account.php">Profile</a></li>
                    <li><a href="my-announcements.php">My Announcements</a></li>
                    <li><a href="saved-announcements.php">Saved Announcements</a></li>
                </ul>
            </li>
            <li><a href="add.html" class="btn">Add Announcement</a></li>
        </ul>
    </nav>
</header>

<main>
    <div class="profile-container">
        <div id="loadingContainer" class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your profile...</div>
        </div>

        <div id="profileContent" style="display: none;">
            <h1>‚úèÔ∏è Edit Your Profile</h1>

            <div id="messageContainer"></div>

            <form id="editProfileForm" enctype="multipart/form-data">
            <div class="photo-section">
                <img id="profilePhotoPreview" src="img/Pawlogo.png" alt="Profile">
                <div class="photo-info">
                    <h3>Profile Photo</h3>
                    <p>Choose a new photo to update your profile picture</p>
                    <input 
                        type="file" 
                        name="profilePhoto"
                        id="profilePhoto"
                        accept="image/*" 
                        class="photo-input"
                    >
                </div>
            </div>

            <div class="form-group">
                <label for="username">Username *</label>
                <input
                    type="text"
                    id="username"
                    name="username"
                    placeholder="Enter your username"
                    required
                    minlength="3"
                >
                <div id="usernameError" class="validation-error"></div>
            </div>

            <div class="form-group">
                <label for="phone">Phone Number *</label>
                <input
                    type="tel"
                    id="phone"
                    name="phone"
                    placeholder="05XXXXXXXX"
                    required
                    pattern="^05\d{8}$"
                >
                <div id="phoneError" class="validation-error"></div>
                <div class="input-hint">Saudi phone format: 05XXXXXXXX</div>
            </div>

            <div class="form-group">
                <label for="password">New Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    placeholder="Leave blank to keep current password"
                    minlength="8"
                >
                <div id="passwordError" class="validation-error"></div>
                <div class="input-hint">Leave blank if you don't want to change your password</div>
            </div>

            <div class="form-group" id="confirmPasswordGroup" style="display: none;">
                <label for="confirmPassword">Confirm New Password *</label>
                <input
                    type="password"
                    id="confirmPassword"
                    placeholder="Re-enter your new password"
                >
                <div id="confirmPasswordError" class="validation-error"></div>
            </div>

            <div class="button-group">
                <a href="account.php" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary" id="saveBtn">
                    üíæ Save Changes
                </button>
            </div>
        </form>
        </div>
    </div>
</main>

<footer>
    <div class="footer-content">
        <div class="footer-left"><span>Paws Connect 2025 ¬©</span></div>
        <div class="footer-right">
            <span>Connect With Us</span>
            <div class="social">
                <img src="img/instaLogo.png" alt="Instagram">
                <img src="img/XLogo.png" alt="X App">
                <img src="img/FacebookLogo.png" alt="Facebook">
            </div>
        </div>
    </div>
</footer>

<script>
const form = document.getElementById('editProfileForm');
const usernameInput = document.getElementById('username');
const phoneInput = document.getElementById('phone');
const passwordInput = document.getElementById('password');
const confirmPasswordInput = document.getElementById('confirmPassword');
const confirmPasswordGroup = document.getElementById('confirmPasswordGroup');
const photoInput = document.getElementById('profilePhoto');
const photoPreview = document.getElementById('profilePhotoPreview');
const saveBtn = document.getElementById('saveBtn');
const messageContainer = document.getElementById('messageContainer');

// Load current user data
async function loadUserData() {
    const loadingContainer = document.getElementById('loadingContainer');
    const profileContent = document.getElementById('profileContent');
    
    try {
        const response = await fetch('edit_profile.php?api=1');
        const data = await response.json();
        
        if (data.success) {
            usernameInput.value = data.user.username;
            phoneInput.value = data.user.phone;
            photoPreview.src = data.user.profilePhoto;
            
            // Show content, hide loading
            loadingContainer.style.display = 'none';
            profileContent.style.display = 'block';
        } else {
            loadingContainer.innerHTML = '<div class="message message-error">Failed to load profile data</div>';
        }
    } catch (error) {
        console.error('Error loading user data:', error);
        loadingContainer.innerHTML = '<div class="message message-error">Error loading profile. Please refresh the page.</div>';
    }
}

passwordInput.addEventListener('input', function() {
    if (this.value.length > 0) {
        confirmPasswordGroup.style.display = 'block';
        confirmPasswordInput.required = true;
    } else {
        confirmPasswordGroup.style.display = 'none';
        confirmPasswordInput.required = false;
        confirmPasswordInput.value = '';
    }
});

photoInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            photoPreview.src = event.target.result;
        };
        reader.readAsDataURL(file);
    }
});

function validateForm() {
    let isValid = true;
    
    document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
    
    if (usernameInput.value.trim().length < 3) {
        document.getElementById('usernameError').textContent = 'Username must be at least 3 characters';
        isValid = false;
    }
    
    const phoneRegex = /^05\d{8}$/;
    if (!phoneRegex.test(phoneInput.value)) {
        document.getElementById('phoneError').textContent = 'Phone must be in format 05XXXXXXXX';
        isValid = false;
    }
    
    if (passwordInput.value.length > 0) {
        if (passwordInput.value.length < 8) {
            document.getElementById('passwordError').textContent = 'Password must be at least 8 characters';
            isValid = false;
        }
        
        if (passwordInput.value !== confirmPasswordInput.value) {
            document.getElementById('confirmPasswordError').textContent = 'Passwords do not match';
            isValid = false;
        }
    }
    
    return isValid;
}

function showMessage(type, text) {
    messageContainer.innerHTML = `<div class="message message-${type}">${text}</div>`;
    messageContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!validateForm()) {
        showMessage('error', '‚ö†Ô∏è Please fix the errors below');
        return;
    }
    
    saveBtn.disabled = true;
    saveBtn.textContent = 'üíæ Saving...';
    
    const formData = new FormData(form);
    
    try {
        const response = await fetch('edit_profile.php', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('success', '‚úÖ Profile updated successfully!');
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            confirmPasswordGroup.style.display = 'none';
            
            await loadUserData();
            
            setTimeout(() => {
                window.location.href = 'account.php';
            }, 2000);
        } else {
            showMessage('error', '‚ùå ' + data.message);
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Save Changes';
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('error', '‚ùå An error occurred. Please try again.');
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Save Changes';
    }
});

loadUserData();
</script>

</body>
</html>
