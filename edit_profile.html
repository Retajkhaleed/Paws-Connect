<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile - Paws Connect</title>
    <link rel="stylesheet" href="StyleCSS.css"> 
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    </head>
<body>

<header>
    <div class="logo">
        <img src="img/PawLogo.png" alt="Paws Connect Logo" class="logo-image">
        <span class="logo-text">Paws Connect</span>
    </div>
    <nav>
        <ul class="nav">
            <li><a href="home_main.php" class="home-btn">Home</a></li>
            <li><a href="adoptable-cats.php">Adopt Cats</a></li>
            <li><a href="lost-cats.php">Lost Cats</a></li>
            <li><a href="sick.php">Sick Cats</a></li>
            <li class="dropdown">
                <a href="#">Account <span class="arrow">‚ñ≤</span></a>
                <ul class="dropdown-content">
                    <li><a href="account.php">Profile</a></li>
                    <li><a href="my-announcements.php">My Announcements</a></li>
                    <li><a href="saved-announcements.php">Saved Announcements</a></li>
                </ul>
            </li>
            <li><a href="add.html" class="btn">Add Announcement</a></li>
        </ul>
    </nav>
</header>


<footer>
    <div class="footer-content">
       Paws Connect 2025 ¬©
    </div>
  </footer>
  
<main>
    <div class="profile-container">
        <div id="root">
            </div>
    </div>
</main>

 

<script type="text/babel">
    // Destructure React hooks for clean code
    const { useState, useEffect } = React;

    // React Component for the Edit Profile page
    function EditProfile() {
        const [formData, setFormData] = useState({
            username: '',
            phone: '',
            password: '',
            confirmPassword: '',
            newPhotoFile: null
        });
        const [initialPhoto, setInitialPhoto] = useState('img/Pawlogo.png');
        const [photoPreview, setPhotoPreview] = useState('img/Pawlogo.png');
        const [loading, setLoading] = useState(true);
        const [isSaving, setIsSaving] = useState(false);
        const [message, setMessage] = useState(null);
        const [errors, setErrors] = useState({});

        // --- 1. Data Loading (useEffect) - Mirrors loadUserData() ---
        useEffect(() => {
            const loadData = async () => {
                try {
                    const response = await fetch('edit_profile.php?api=1');
                    const data = await response.json();
                    
                    if (data.success) {
                        setFormData(prev => ({
                            ...prev,
                            username: data.user.username,
                            phone: data.user.phone
                        }));
                        setInitialPhoto(data.user.profilePhoto);
                        setPhotoPreview(data.user.profilePhoto);
                    } else {
                        setMessage({ type: 'error', text: data.message || 'Failed to load profile data' });
                    }
                } catch (error) {
                    setMessage({ type: 'error', text: 'Error loading profile. Please refresh.' });
                } finally {
                    setLoading(false);
                }
            };
            loadData();
        }, []); // Run only once on component mount

        // --- 2. Change Handlers ---
        const handleInputChange = (e) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
            setErrors(prev => ({ ...prev, [name]: '' }));
        };

        const handlePhotoChange = (e) => {
            const file = e.target.files[0];
            setFormData(prev => ({ ...prev, newPhotoFile: file }));
            
            if (file) {
                // Create a local preview URL
                setPhotoPreview(URL.createObjectURL(file));
            } else {
                // Reset preview if file selection is canceled
                setPhotoPreview(initialPhoto); 
            }
        };

        // --- 3. Validation Logic - Mirrors validateForm() ---
        const validateForm = () => {
            const newErrors = {};
            let isValid = true;
            
            if (formData.username.trim().length < 3) {
                newErrors.username = 'Username must be at least 3 characters';
                isValid = false;
            }
            
            const phoneRegex = /^05\d{8}$/;
            if (!phoneRegex.test(formData.phone)) {
                newErrors.phone = 'Phone must be in Saudi format: 05XXXXXXXX';
                isValid = false;
            }
            
            if (formData.password.length > 0) {
                if (formData.password.length < 8) {
                    newErrors.password = 'Password must be at least 8 characters';
                    isValid = false;
                }
                if (formData.password !== formData.confirmPassword) {
                    newErrors.confirmPassword = 'Passwords do not match';
                    isValid = false;
                }
            }
            
            setErrors(newErrors);
            return isValid;
        };

        // --- 4. Form Submission - Mirrors original submit listener ---
        const handleSubmit = async (e) => {
            e.preventDefault();
            setMessage(null);
            
            if (!validateForm()) {
                setMessage({ type: 'error', text: '‚ö†Ô∏è Please fix the errors below' });
                return;
            }
            
            setIsSaving(true);

            const formPayload = new FormData();
            formPayload.append('username', formData.username);
            formPayload.append('phone', formData.phone);
            
            if (formData.password) {
                formPayload.append('password', formData.password);
            }
            if (formData.newPhotoFile) {
                formPayload.append('profilePhoto', formData.newPhotoFile);
            }
            
            try {
                const response = await fetch('edit_profile.php', {
                    method: 'POST',
                    body: formPayload
                });
                
                const data = await response.json();
                
                if (data.success) {
                    setMessage({ type: 'success', text: '‚úÖ Profile updated successfully!' });
                    
                    // Reset sensitive fields and re-load data
                    setFormData(prev => ({ ...prev, password: '', confirmPassword: '', newPhotoFile: null }));
                    
                    setTimeout(() => {
                        window.location.href = 'account.php';
                    }, 2000);
                } else {
                    setMessage({ type: 'error', text: '‚ùå ' + data.message });
                }
            } catch (error) {
                setMessage({ type: 'error', text: '‚ùå An unexpected error occurred.' });
            } finally {
                setIsSaving(false);
            }
        };

        // --- Conditional Rendering ---
        if (loading) {
            return (
                <div id="loadingContainer" className="loading-container">
                    <div className="loading-spinner"></div>
                    <div className="loading-text">Loading your profile...</div>
                </div>
            );
        }

        // Main Component Render (JSX)
        return (
            <div>
                <h1>‚úèÔ∏è Edit Your Profile</h1>

                {/* Message Container */}
                {message && (
                    <div id="messageContainer">
                        <div className={`message message-${message.type}`}>{message.text}</div>
                    </div>
                )}

                <form id="editProfileForm" onSubmit={handleSubmit} encType="multipart/form-data">
                    <div className="photo-section">
                        <img id="profilePhotoPreview" src={photoPreview} alt="Profile" />
                        <div className="photo-info">
                            <h3>Profile Photo</h3>
                            <p>Choose a new photo to update your profile picture</p>
                            <input 
                                type="file" 
                                name="profilePhoto"
                                id="profilePhoto"
                                accept="image/*" 
                                className="photo-input"
                                onChange={handlePhotoChange}
                            />
                        </div>
                    </div>

                    <div className="form-group">
                        <label htmlFor="username">Username *</label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            placeholder="Enter your username"
                            required
                            minLength="3"
                            value={formData.username}
                            onChange={handleInputChange}
                        />
                        {errors.username && <div id="usernameError" className="validation-error">{errors.username}</div>}
                    </div>

                    <div className="form-group">
                        <label htmlFor="phone">Phone Number *</label>
                        <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="05XXXXXXXX"
                            required
                            pattern="^05\d{8}$"
                            value={formData.phone}
                            onChange={handleInputChange}
                        />
                        {errors.phone && <div id="phoneError" className="validation-error">{errors.phone}</div>}
                        <div className="input-hint">Saudi phone format: 05XXXXXXXX</div>
                    </div>

                    <div className="form-group">
                        <label htmlFor="password">New Password</label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            placeholder="Leave blank to keep current password"
                            minLength="8"
                            value={formData.password}
                            onChange={handleInputChange}
                        />
                        {errors.password && <div id="passwordError" className="validation-error">{errors.password}</div>}
                        <div className="input-hint">Leave blank if you don't want to change your password</div>
                    </div>

                    {/* Conditional display logic based on state */}
                    {formData.password.length > 0 && (
                        <div className="form-group" id="confirmPasswordGroup">
                            <label htmlFor="confirmPassword">Confirm New Password *</label>
                            <input
                                type="password"
                                id="confirmPassword"
                                name="confirmPassword"
                                placeholder="Re-enter your new password"
                                required
                                value={formData.confirmPassword}
                                onChange={handleInputChange}
                            />
                            {errors.confirmPassword && <div id="confirmPasswordError" className="validation-error">{errors.confirmPassword}</div>}
                        </div>
                    )}

                    <div className="button-group">
                        <a href="account.php" className="btn btn-secondary">Cancel</a>
                        <button type="submit" className="btn btn-primary" id="saveBtn" disabled={isSaving}>
                            {isSaving ? 'üíæ Saving...' : 'üíæ Save Changes'}
                        </button>
                    </div>
                </form>
            </div>
        );
    }

    // Initialize React on the root element
    const rootElement = document.getElementById("root");
    const root = ReactDOM.createRoot(rootElement);
    root.render(<EditProfile />);
</script>
</body>
</html>
